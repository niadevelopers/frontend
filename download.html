<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Download</title>
</head>
<body>
<h1>Download Your Files</h1>
<p id="timer">05:00</p>
<a id="downloadBtn" href="#">Download</a>
<p id="status"></p>

<script>
const BASE_URL = 'https://backend-6-898a.onrender.com';

const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get('token');
let countdown = 300;

const timerEl = document.getElementById('timer');
const btn = document.getElementById('downloadBtn');
const statusEl = document.getElementById('status');

function updateTimer() {
  const minutes = String(Math.floor(countdown/60)).padStart(2,'0');
  const seconds = String(countdown%60).padStart(2,'0');
  timerEl.textContent = `${minutes}:${seconds}`;
  countdown--;
  if (countdown < 0) {
    clearInterval(interval);
    btn.style.display = 'none';
    alert('Download link expired. Please purchase again.');
  }
}

const interval = setInterval(updateTimer, 1000);

btn.addEventListener('click', async (e) => {
  e.preventDefault();
  statusEl.textContent = 'Preparing download...';
  try {
    const res = await fetch(`${BASE_URL}/api/download/${token}`);
    if (!res.ok) throw new Error(`Server returned ${res.status}`);

    // Get file info
    const contentType = res.headers.get('content-type');
    const contentLength = Number(res.headers.get('content-length') || 0);
    const blob = await res.blob();

    // Decide if we should zip or not (5MB threshold)
    const ZIP_THRESHOLD = 5 * 1024 * 1024; // 5 MB

    let downloadName = 'file';
    if (contentType.includes('application/zip') || contentLength > ZIP_THRESHOLD) {
      downloadName += '.zip';
    } else {
      // try to extract extension from content-type
      const ext = contentType.split('/')[1] || 'bin';
      downloadName += '.' + ext;
    }

    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = downloadName;
    link.click();

    statusEl.textContent = 'Download started.';
  } catch (err) {
    console.error(err);
    statusEl.textContent = 'Failed to download file. Please try again.';
  }
});
</script>
</body>
</html>
